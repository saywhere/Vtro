/**
 * 
 *   This file is part of Vtro.
 *   Copyright (C) 2020  wk989898
 *   
 *   Vtro is free software: you can redistribute it and/or modify
 *   it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation, either version 3 of the License, or
 *   (at your option) any later version.
 *   
 *   This program is distributed in the hope that it will be useful,
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *   GNU General Public License for more details.
 *   
 *   You should have received a copy of the GNU General Public License
 *   along with this program.  If not, see <https://www.gnu.org/licenses/>.
 *   
 */

"use strict";const{app:e,BrowserWindow:o,ipcMain:n,Menu:t,Tray:r,shell:i}=require("electron"),s=require("path"),l=require("fs"),a=require("child_process"),c=require("http"),d=require("process"),p=require("dns"),{config:g}=require("process");var u,f,y,w,h=null,x={isIP:!0,fast_open:!1,reuse_port:!1,reuse_session:!0};function S(){(u=new o({show:!1,width:800,height:600,webPreferences:{nodeIntegration:!0,devTools:!0}})).loadFile("index.html"),u.on("close",e=>{e.preventDefault(),u.hide()})}function j(e,o){return u.webContents.send(e,o)}function b(e){return Object.prototype.toString.call(e).slice(8).replace("]","").toLowerCase()}function v(o){let n=e.isPackaged?s.resolve(e.getPath("exe"),"../"):"";return s.resolve(n,o)}function m(e,o){e&&(null==o&&(o=v("./trojan/log.txt")),l.appendFile(o,function(...e){const[o="-",n=" ",t=":"]=e,r=new Date;return r.getFullYear().toString()+o+r.getMonth().toString().padStart(2,"0")+o+r.getDay().toString().padStart(2,"0")+n+r.getHours().toString().padStart(2,"0")+t+r.getMinutes().toString().padStart(2,"0")+t+r.getSeconds().toString().padStart(2,"0")}()+e+"\n","utf-8",()=>{}))}function _(e,o,n){a.execFile("./sysproxy.exe",[e,o,n],{cwd:v("./proxy"),windowsHide:!0},(e,o,n)=>{e&&m(e)&&h&&h.close(),n&&m(n)})}function F(){w=a.execFile("./privoxy.exe",{cwd:v("./proxy"),windowsHide:!0},e=>{e&&m("privoxy error!has you close privoxy?\nplease check http://localhost:1081\n")&&h&&h.close()}),w.pid}function k(){y&&y.kill(),w&&w.kill(),null!=h&&(h.close(),h=null)}async function N(e,o,n){return o?(await P("a",null,t=>{n&&n(t),"array"===b(o)?t[e].unshift(...o):t[e].unshift(o)}),Promise.resolve(!0)):(m("there is no data to be added"),Promise.resolve(!1))}function q(e,o){P("a",null,n=>{"array"===b(n[e])&&(n[e]=n[e].filter(e=>o(e)))})}async function P(e,o="",n,t){let r=v("./trojan/conf.json");return"r"===e?await l.readFile(r,"utf-8",(e,o)=>{e&&m(e),o=JSON.parse(o.toString()),n(o)}):"w"===e?await l.writeFile(r,JSON.stringify(o),e=>{e&&m(e)}):"a"===e?await l.readFile(r,"utf-8",(e,o)=>{e&&m(e),o=JSON.parse(o.toString()),n(o),l.writeFileSync(r,JSON.stringify(o))}):void 0}!e.isPackaged&&require("copy-dir").sync("extra-trojan","trojan",{cover:!1}),e.name="Vtro",e.requestSingleInstanceLock()?(e.on("second-instance",(e,o,n)=>{u&&(u.isMinimized()&&u.restore(),u.focus(),u.show())}),e.on("ready",()=>{S();const o=e.isPackaged;!o&&u.webContents.openDevTools(),"test"===d.env.NODE_ENV&&u.webContents.closeDevTools(),f=new r(o?s.resolve(e.getAppPath(),"../tray.ico"):"icon/tray.ico");let n=[{label:"退出",click(){e.exit()}}];const i=t.buildFromTemplate(n);f.setToolTip("Vtro"),f.addListener("click",()=>{u.show()}),f.setContextMenu(i),f.on("click",()=>{!u.isVisible()&&u.show()})})):e.quit(),e.on("before-quit",()=>{k()}),e.on("window-all-closed",(function(o){"darwin"!==d.platform&&e.quit()})),e.on("activate",(function(){0===o.getAllWindows().length&&S()}));let O=0,C=0;n.on("link",(e,o)=>{let n;k(),l.readFile(v("./trojan/config.json"),"utf-8",(e,o)=>{e&&m(e);let n=JSON.parse(o.toString());P("r",null,async e=>{let o;const{isIP:t=!0,fast_open:r=!1,reuse_port:i=!1,reuse_session:s=!0}=x;o=e.config.night.ip&&"night"===e.config.mode?e.config.night:e.config.day,!o.ip&&e.nodes[0]&&(o=e.nodes[0],e.config.day=o,j("config",e.config)),n.remote_addr=t?o.ip:o.addr,n.remote_port=o.port,n.password[0]=o.password,n.local_port=e.config.listen[0]||1080,n.tcp.reuse_port=i,n.tcp.fast_open=r,n.ssl.reuse_session=s,await l.writeFile(v("./trojan/config.json"),JSON.stringify(n),"utf-8",e=>{e&&m(e)})})}),function(e=e){e.stderr.on("data",e=>{e.replace(/(\d*) bytes received, (\d*) bytes sent/,(e,o,n)=>{o&&n&&(O+=Number(o),C+=Number(n),j("flow",[O,C]))})}).on("close",()=>{O=0,C=0})}(y=a.execFile("trojan.exe",{cwd:v("./trojan"),windowsHide:!0},(e,o,n)=>{n&&m(n,v("./trojan/trojan-log.txt"))})),y.pid,P("r",null,e=>{const o=e.config.proxy||"pac",[t,r=1081,i=1082]=e.config.listen;if(l.readFile(v("./proxy/config.txt"),(e,o)=>{e&&m(e);let n=o.toString().replace(/(listen-address.+\:)\d+\n/,`$1${r}\n`).replace(/(forward-socks5.+\:)\d+.+\n/,`$1${t} .\n`);l.writeFileSync(v("./proxy/config.txt"),n,()=>{})}),"global"===o){n=`http://127.0.0.1:${r}`,_(o,n,"localhost;127.*"),F()}else"pac"===o?(null==h&&(h=function(){const e=c.createServer();return e.on("request",(e,o)=>{"/pac"===e.url&&(o.setHeader("Content-Type","application/x-ns-proxy-autoconfig"),l.readFile(v("./proxy/proxy.pac"),(e,n)=>{e&&o.end("error"),o.end(n)}))}),e}()),n=`http://127.0.0.1:${i}/pac`,!h.listening&&h.listen(i,"127.0.0.1",()=>{_(o,n),F()})):_("set",1)}),e.reply("linked"),console.log("trojan open")}).on("close",(e,o)=>{k(),e.reply("closed"),console.log("trojan closed")}),n.on("get-nodes",e=>{P("r",null,o=>{if(!o.nodes)return m("please check your conf.json");e.reply("update-nodes",o.nodes)})}).on("change-linkNode",(e,o)=>{o&&P("a",null,n=>{n.config.day=o,e.reply("config",n.config)})}).on("change-nightNode",(e,o)=>{o&&P("a",null,n=>{n.config.night=o,e.reply("config",n.config)})}).on("change-mode",(e,o)=>{P("a",null,n=>{n.config.mode=o,e.reply("update-mode")})}),n.on("get-sub",e=>{P("r",null,o=>{e.reply("subs",o.sub||[])})}).on("update",(e,o)=>{N("nodes",o.nodes,e=>{e.nodes.length=0}).finally(e=>{setTimeout(()=>{N("sub",o.sub,e=>{e.sub.length=0})},1e3)})}).on("remove-sub",(e,o)=>{q("sub",e=>e!==o),e.reply("removed")}).on("sub-proxy",(e,o)=>{o?l.readFile(v("./trojan/config.json"),async(e,o)=>{e&&m(e);const{local_addr:n,local_port:t}=JSON.parse(o.toString());let r=`socks://${n}:${t},localhost`;u.webContents.session.setProxy({proxyRules:r})}):u.webContents.session.setProxy({})}),n.on("add-node",(e,o)=>{o.ip?N("nodes",o):p.resolve4(o.addr,(e,n)=>{e&&(o.ip="0"),"array"===b(n)&&(n=n[0]),o.ip=n,N("nodes",o)})}).on("delete-node",(e,o)=>{q("nodes",e=>e.ip?e.ip!==o:e.addr!=e.addr),e.reply("deleted")}).on("update-node",(e,o)=>{P("a",null,e=>{e.nodes=o})}),n.on("getConf",e=>{P("r",null,o=>{e.reply("config",o.config)})}).on("setConf",(e,o)=>{P("a",null,n=>{Object.assign(n.config,o),e.reply("config",n.config)}),setTimeout(()=>{!function(e){const o=n.listeners(e)[0];"function"===b(o)?o({reply:j}):console.log(`not found Event ${e}\n,trigger failed`)}("link")},1e3)}),n.on("set-login",(o,n)=>{e.setLoginItemSettings({openAsHidden:!0,openAtLogin:n})}).on("get-login",o=>{o.reply("login",e.getLoginItemSettings().openAtLogin)}).on("other",(e,[o,n])=>{o in x&&(x[o]=n)}),n.on("pac",e=>{a.exec("node fetchPAC.js",{cwd:v("./proxy"),windowsHide:!0},(e,o,n)=>{e&&m("更新pac失败"),m(o)})}).on("trojan-log",e=>{i.openItem(v("trojan/trojan-log.txt"))}).on("link-log",e=>{i.openItem(v("trojan/log.txt"))}).on("change_log_level",(e,o)=>{l.readFile(v("trojan/config.json"),(e,n)=>{e&&m(e);let t=JSON.parse(n);t.log_level=o,l.writeFile(v("trojan/config.json"),JSON.stringify(t),e=>{})})}).on("get_log_level",e=>{l.readFile(v("trojan/config.json"),(o,n)=>{o&&m(o);const t=JSON.parse(n).log_level;e.reply("log_level",t)})});var T=null;e.isPackaged||(T=t.buildFromTemplate([{id:"refresh",label:"refresh",role:"forceReload"}])),t.setApplicationMenu(T);
//# sourceMappingURL=main.js.map
